<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All-in-One Ads Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        th { @apply px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider; }
        td { @apply px-6 py-4 whitespace-nowrap text-sm text-gray-800; }
        .table-section { @apply align-middle inline-block min-w-full; }
        .card { @apply bg-white rounded-xl shadow-md overflow-hidden; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-8 space-y-8">
        <header>
            <h1 class="text-4xl font-bold text-gray-900">All-in-One Dashboard</h1>
            <p class="mt-2 text-lg text-gray-600">Correlating Facebook Ad performance with real user behavior from Hotjar.</p>
        </header>

        <!-- Facebook Ads Section -->
        <div class="card">
            <h2 class="text-xl font-bold text-gray-800 p-6 border-b border-gray-200">Facebook Campaign Insights (This Week)</h2>
            <div id="fb-table-container" class="overflow-x-auto">
                <div class="table-section">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th>Date</th>
                                <th>Campaign</th>
                                <th>Spend</th>
                                <th>Impressions</th>
                                <th>CTR</th>
                                <th>Purchases</th>
                                <!-- Funnel Rates -->
                                <th class="text-green-600">Search Rate</th>
                                <th class="text-green-600">ATC Rate</th>
                                <th class="text-green-600">Purchase Rate</th>
                            </tr>
                        </thead>
                        <tbody id="insights-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- FB Data Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="fb-loading-state" class="p-8 text-center text-gray-500">
                <p>Loading Facebook data...</p>
            </div>
        </div>

        <!-- Hotjar Section -->
        <div class="card">
            <h2 class="text-xl font-bold text-gray-800 p-6 border-b border-gray-200">Recent User Recordings (Hotjar)</h2>
            <div id="hotjar-table-container" class="overflow-x-auto">
                 <div class="table-section">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th>Date</th>
                                <th>Country</th>
                                <th>Device</th>
                                <th>Browser</th>
                                <th>Duration</th>
                                <th>Link</th>
                            </tr>
                        </thead>
                        <tbody id="hotjar-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Hotjar Data Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="hotjar-loading-state" class="p-8 text-center text-gray-500">
                <p>Loading Hotjar recordings...</p>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const fbTableBody = document.getElementById('insights-table-body');
        const fbLoadingState = document.getElementById('fb-loading-state');
        const hotjarTableBody = document.getElementById('hotjar-table-body');
        const hotjarLoadingState = document.getElementById('hotjar-loading-state');

        // --- Formatters ---
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        const formatNumber = (num) => new Intl.NumberFormat('en-US').format(num);
        const formatPercent = (num) => `${num.toFixed(2)}%`;
        const formatDuration = (seconds) => `${Math.floor(seconds / 60)}m ${seconds % 60}s`;

        // --- RENDER FUNCTIONS ---
        const renderFbRow = (data) => `
            <tr>
                <td class="font-medium">${new Date(data.date).toLocaleDateString()}</td>
                <td class="font-bold">${data.campaignName}</td>
                <td>${formatCurrency(data.spend)}</td>
                <td>${formatNumber(data.impressions)}</td>
                <td>${formatPercent(data.ctr)}</td>
                <td class="font-bold text-blue-600">${formatNumber(data.purchases)}</td>
                <td class="font-semibold text-green-600">${formatPercent(data.lpvToSearchRate)}</td>
                <td class="font-semibold text-green-600">${formatPercent(data.searchToAtcRate)}</td>
                <td class="font-semibold text-green-600">${formatPercent(data.icToPurchaseRate)}</td>
            </tr>
        `;
        
        const renderHotjarRow = (rec) => `
             <tr>
                <td class="font-medium">${new Date(rec.creation_time).toLocaleString()}</td>
                <td>${rec.country_name}</td>
                <td>${rec.device}</td>
                <td>${rec.browser}</td>
                <td>${formatDuration(rec.duration)}</td>
                <td><a href="${rec.play_url}" target="_blank" class="text-blue-600 hover:underline">Watch Recording</a></td>
            </tr>
        `;

        // --- DATA FETCHING ---
        const fetchFbInsights = async () => {
            try {
                const response = await fetch('/api/insights');
                if (!response.ok) throw new Error('Facebook API Error');
                const data = await response.json();
                if (data.length > 0) {
                    fbTableBody.innerHTML = data.map(renderFbRow).join('');
                    fbLoadingState.style.display = 'none';
                } else {
                    fbLoadingState.innerHTML = '<p>No Facebook data found for this week.</p>';
                }
            } catch (error) {
                console.error(error);
                fbLoadingState.innerHTML = '<p class="text-red-500">Error loading Facebook data.</p>';
            }
        };

        const fetchHotjarRecordings = async () => {
             try {
                const response = await fetch('/api/hotjar');
                if (!response.ok) throw new Error('Hotjar API Error');
                const data = await response.json();
                if (data.length > 0) {
                    hotjarTableBody.innerHTML = data.map(renderHotjarRow).join('');
                    hotjarLoadingState.style.display = 'none';
                } else {
                    hotjarLoadingState.innerHTML = '<p>No recent Hotjar recordings found.</p>';
                }
            } catch (error) {
                console.error(error);
                hotjarLoadingState.innerHTML = '<p class="text-red-500">Error loading Hotjar data. Check Site ID.</p>';
            }
        };

        window.addEventListener('load', () => {
            fetchFbInsights();
            fetchHotjarRecordings();
        });
    </script>
</body>
</html>