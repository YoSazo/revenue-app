<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Performance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-header { @apply sticky top-0 bg-gray-100; }
        th, td { @apply px-4 py-3 text-left text-sm; }
        th { @apply font-semibold text-gray-600 uppercase tracking-wider; }
        tbody tr:nth-child(even) { @apply bg-gray-50; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-6">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Campaign Insights Dashboard</h1>
            <p class="text-gray-500">Weekly performance overview for key campaigns</p>
        </header>

        <main class="bg-white rounded-lg shadow-md overflow-hidden">
            <div id="table-container" class="max-h-[70vh] overflow-y-auto">
                <table class="w-full">
                    <thead class="table-header">
                        <tr>
                            <th>Date</th>
                            <th>Campaign</th>
                            <th>Spend</th>
                            <th>Impressions</th>
                            <th>CTR</th>
                            <th>Reach</th>
                            <th>Frequency</th>
                            <th class="text-blue-600">LP Views</th>
                            <th class="text-blue-600">Searches</th>
                            <th class="text-blue-600">Adds to Cart</th>
                            <th class="text-blue-600">Checkouts</th>
                            <th class="text-blue-600">Purchases</th>
                            <th class="text-green-600">Search Rate</th>
                            <th class="text-green-600">ATC Rate</th>
                            <th class="text-green-600">Checkout Rate</th>
                            <th class="text-green-600">Purchase Rate</th>
                        </tr>
                    </thead>
                    <tbody id="insights-table-body">
                        <!-- Data will be injected here -->
                    </tbody>
                    <tfoot class="sticky bottom-0 bg-gray-200 font-bold">
                        <!-- Totals will be injected here -->
                    </tfoot>
                </table>
            </div>
            <div id="loading-state" class="p-6 text-center text-gray-500">
                <p>Loading campaign data...</p>
            </div>
        </main>
    </div>

    <script>
        const tableBody = document.getElementById('insights-table-body');
        const tableFooter = document.getElementById('table-footer');
        const loadingState = document.getElementById('loading-state');
        
        // --- FORMATTERS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        const formatNumber = (num) => new Intl.NumberFormat('en-US').format(num);
        const formatPercent = (num) => `${num.toFixed(2)}%`;

        const renderTableRow = (data) => `
            <tr>
                <td class="font-medium text-gray-800">${new Date(data.date).toLocaleDateString()}</td>
                <td class="text-gray-700">${data.campaignName.replace(/\|/g, ' | ')}</td>
                <td>${formatCurrency(data.spend)}</td>
                <td>${formatNumber(data.impressions)}</td>
                <td>${formatPercent(data.ctr)}</td>
                <td>${formatNumber(data.reach)}</td>
                <td>${data.frequency.toFixed(2)}</td>
                <td class="font-medium text-blue-700">${formatNumber(data.lpv)}</td>
                <td class="font-medium text-blue-700">${formatNumber(data.searches)}</td>
                <td class="font-medium text-blue-700">${formatNumber(data.atc)}</td>
                <td class="font-medium text-blue-700">${formatNumber(data.ic)}</td>
                <td class="font-medium text-blue-700">${formatNumber(data.purchases)}</td>
                <td class="font-semibold text-green-700">${formatPercent(data.lpvToSearchRate)}</td>
                <td class="font-semibold text-green-700">${formatPercent(data.searchToAtcRate)}</td>
                <td class="font-semibold text-green-700">${formatPercent(data.atcToIcRate)}</td>
                <td class="font-semibold text-green-700">${formatPercent(data.icToPurchaseRate)}</td>
            </tr>
        `;

        const renderTotalsRow = (totals) => {
             const footerRow = document.createElement('tr');
             footerRow.innerHTML = `
                <td colspan="2">Totals</td>
                <td>${formatCurrency(totals.spend)}</td>
                <td>${formatNumber(totals.impressions)}</td>
                <td>${formatPercent(totals.ctr)}</td>
                <td>${formatNumber(totals.reach)}</td>
                <td>-</td>
                <td class="font-medium text-blue-700">${formatNumber(totals.lpv)}</td>
                <td class="font-medium text-blue-700">${formatNumber(totals.searches)}</td>
                <td class="font-medium text-blue-700">${formatNumber(totals.atc)}</td>
                <td class="font-medium text-blue-700">${formatNumber(totals.ic)}</td>
                <td class="font-medium text-blue-700">${formatNumber(totals.purchases)}</td>
                <td class="font-semibold text-green-700">${formatPercent(totals.lpvToSearchRate)}</td>
                <td class="font-semibold text-green-700">${formatPercent(totals.searchToAtcRate)}</td>
                <td class="font-semibold text-green-700">${formatPercent(totals.atcToIcRate)}</td>
                <td class="font-semibold text-green-700">${formatPercent(totals.icToPurchaseRate)}</td>
            `;
            tableFooter.innerHTML = ''; // Clear previous footer
            tableFooter.appendChild(footerRow);
        }

        const fetchInsights = async () => {
            try {
                const response = await fetch('/api/insights');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                if (data.length > 0) {
                    tableBody.innerHTML = data.map(renderTableRow).join('');
                    
                    // Calculate and render totals
                    const totals = data.reduce((acc, row) => {
                        acc.spend += row.spend;
                        acc.impressions += row.impressions;
                        acc.clicks += row.clicks;
                        acc.reach += row.reach; // Note: reach is unique, summing isn't accurate but gives an idea
                        acc.lpv += row.lpv;
                        acc.searches += row.searches;
                        acc.atc += row.atc;
                        acc.ic += row.ic;
                        acc.purchases += row.purchases;
                        return acc;
                    }, { spend: 0, impressions: 0, clicks: 0, reach: 0, lpv: 0, searches: 0, atc: 0, ic: 0, purchases: 0 });

                    // Calculate overall rates for totals
                    totals.ctr = (totals.clicks / totals.impressions) * 100 || 0;
                    totals.lpvToSearchRate = (totals.searches / totals.lpv) * 100 || 0;
                    totals.searchToAtcRate = (totals.atc / totals.searches) * 100 || 0;
                    totals.atcToIcRate = (totals.ic / totals.atc) * 100 || 0;
                    totals.icToPurchaseRate = (totals.purchases / totals.ic) * 100 || 0;

                    renderTotalsRow(totals);
                    loadingState.style.display = 'none';
                } else {
                    loadingState.innerHTML = '<p>No performance data found for the selected campaigns this week.</p>';
                }
            } catch (error) {
                console.error('Failed to fetch dashboard data:', error);
                loadingState.innerHTML = '<p class="text-red-500">Error: Could not load data from the server.</p>';
            }
        };

        window.addEventListener('load', fetchInsights);
    </script>
</body>
</html>