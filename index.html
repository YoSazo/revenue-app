<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Performance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { background: #10b981; color: white; }
        .tab-inactive { background: white; color: #6b7280; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-md mx-auto min-h-screen bg-white shadow-xl">
        <!-- Header -->
        <div class="bg-white px-4 py-6 border-b">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-bold text-gray-900">iPhone 16 Pro - 7</h1>
                <button id="toggle-revenue" class="text-sm font-medium text-blue-600">Hide Revenue</button>
            </div>
            
            <!-- Time Period Tabs -->
            <div class="flex gap-2 mb-4">
                <button class="tab-active px-4 py-2 rounded-full text-sm font-medium transition" data-period="today">Today</button>
                <button class="tab-inactive px-4 py-2 rounded-full text-sm font-medium transition" data-period="yesterday">Yesterday</button>
                <button class="tab-inactive px-4 py-2 rounded-full text-sm font-medium transition" data-period="week">This Week</button>
            </div>

            <!-- Revenue Card -->
            <div id="revenue-card" class="bg-gray-50 rounded-2xl p-6 border border-gray-200">
                <p class="text-sm text-gray-600 mb-2">Total Revenue</p>
                <p id="total-revenue" class="text-4xl font-bold text-gray-900 mb-3">$13,859.22</p>
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-green-600 font-semibold">10% Commission</span>
                    <span id="commission" class="text-gray-600">$1,385.92</span>
                </div>
            </div>
        </div>

        <!-- Metrics Section -->
        <div class="px-4 py-6 space-y-4">
            <h2 class="text-lg font-semibold text-gray-900">Funnel Metrics</h2>
            
            <div class="space-y-3">
                <!-- Landing Page Views -->
                <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-600">Landing Page Views</span>
                        <span id="lpv" class="text-lg font-bold text-gray-900">0</span>
                    </div>
                </div>

                <!-- Searches -->
                <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-600">Searches</span>
                        <span id="searches" class="text-lg font-bold text-gray-900">0</span>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        <span id="lpv-to-search-rate">0%</span> from LPV
                    </div>
                </div>

                <!-- Add to Carts -->
                <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-600">Add to Carts</span>
                        <span id="atc" class="text-lg font-bold text-gray-900">0</span>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        <span id="search-to-atc-rate">0%</span> from Searches
                    </div>
                </div>

                <!-- Initiate Checkout -->
                <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-600">Initiate Checkout</span>
                        <span id="ic" class="text-lg font-bold text-gray-900">0</span>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        <span id="atc-to-ic-rate">0%</span> from ATC
                    </div>
                </div>

                <!-- Payment Info Adds -->
                <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-600">Payment Info Adds</span>
                        <span id="pia" class="text-lg font-bold text-gray-900">0</span>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        <span id="ic-to-pia-rate">0%</span> from Checkouts
                    </div>
                </div>

                <!-- Purchases -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border border-green-200 shadow-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-green-700">Purchases</span>
                        <span id="purchases" class="text-lg font-bold text-green-700">0</span>
                    </div>
                    <div class="mt-2 text-xs text-green-600">
                        <span id="pia-to-purchase-rate">0%</span> from Payment Info
                    </div>
                </div>
            </div>
        </div>

        <!-- Ad Performance Metrics -->
        <div id="ad-metrics" class="px-4 py-6 space-y-4 border-t">
            <h2 class="text-lg font-semibold text-gray-900">Ad Performance</h2>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <p class="text-xs text-gray-500 mb-1">Spend</p>
                    <p id="spend" class="text-lg font-bold text-gray-900">$0.00</p>
                </div>
                <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <p class="text-xs text-gray-500 mb-1">ROAS</p>
                    <p id="roas" class="text-lg font-bold text-green-600">0.00x</p>
                </div>
                <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <p class="text-xs text-gray-500 mb-1">CPM</p>
                    <p id="cpm" class="text-lg font-bold text-gray-900">$0.00</p>
                </div>
                <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <p class="text-xs text-gray-500 mb-1">CPC</p>
                    <p id="cpc" class="text-lg font-bold text-gray-900">$0.00</p>
                </div>
            </div>
        </div>

        <!-- Refresh Button -->
        <div class="px-4 pb-6">
            <button id="refresh-btn" class="w-full bg-blue-600 text-white font-semibold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition">
                Refresh Data
            </button>
        </div>

        <!-- Zapier Purchases List -->
        <div id="purchases-section" class="px-4 pb-6 border-t pt-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Zapier Purchases</h2>
                <button id="clear-all-btn" class="text-sm text-red-600 font-medium">Clear All</button>
            </div>
            <div id="purchases-list" class="space-y-2"></div>
        </div>
    </div>

    <script>
        let revenueVisible = true;
        let currentPeriod = 'today';
        let allFbData = [];

        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        const formatNumber = (num) => new Intl.NumberFormat('en-US').format(num);

        // Date filtering helper
        function filterDataByPeriod(data, period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);

            return data.filter(row => {
                const rowDate = new Date(row.date);
                const rowDateOnly = new Date(rowDate.getFullYear(), rowDate.getMonth(), rowDate.getDate());
                
                if (period === 'today') {
                    return rowDateOnly.getTime() === today.getTime();
                } else if (period === 'yesterday') {
                    return rowDateOnly.getTime() === yesterday.getTime();
                } else if (period === 'week') {
                    return rowDateOnly >= weekAgo;
                }
                return true;
            });
        }

        // Toggle revenue visibility
        document.getElementById('toggle-revenue').addEventListener('click', () => {
            revenueVisible = !revenueVisible;
            const revenueCard = document.getElementById('revenue-card');
            const adMetrics = document.getElementById('ad-metrics');
            const toggleBtn = document.getElementById('toggle-revenue');
            
            if (revenueVisible) {
                revenueCard.classList.remove('hidden');
                adMetrics.classList.remove('hidden');
                toggleBtn.textContent = 'Hide Revenue';
            } else {
                revenueCard.classList.add('hidden');
                adMetrics.classList.add('hidden');
                toggleBtn.textContent = 'Show Revenue';
            }
        });

        // Tab switching
        document.querySelectorAll('[data-period]').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('[data-period]').forEach(t => {
                    t.classList.remove('tab-active');
                    t.classList.add('tab-inactive');
                });
                tab.classList.add('tab-active');
                tab.classList.remove('tab-inactive');
                currentPeriod = tab.dataset.period;
                fetchData();
            });
        });

        async function fetchData() {
            try {
                // Fetch Facebook Ads data
                const fbResponse = await fetch('/api/insights');
                if (!fbResponse.ok) throw new Error('FB API Error');
                const fbData = await fbResponse.json();
                
                // Fetch Zapier purchase data
                const zapierResponse = await fetch('/api/purchase');
                let zapierRevenue = 0;
                if (zapierResponse.ok) {
                    const zapierData = await zapierResponse.json();
                    zapierRevenue = zapierData.totalRevenue || 0;
                }
                
                // Calculate totals from Facebook data
                const totals = fbData.reduce((acc, row) => {
                    acc.spend += row.spend;
                    acc.lpv += row.lpv;
                    acc.searches += row.searches;
                    acc.atc += row.atc;
                    acc.ic += row.ic;
                    acc.pia += row.pia;
                    acc.purchases += row.purchases;
                    acc.fbRevenue += row.spend * row.roas;
                    return acc;
                }, { spend: 0, lpv: 0, searches: 0, atc: 0, ic: 0, pia: 0, purchases: 0, fbRevenue: 0 });

                // Combine Facebook revenue with Zapier revenue
                const totalRevenue = totals.fbRevenue + zapierRevenue;
                const overallROAS = totals.spend > 0 ? totalRevenue / totals.spend : 0;

                // Update UI
                document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
                document.getElementById('commission').textContent = formatCurrency(totalRevenue * 0.1);
                document.getElementById('lpv').textContent = formatNumber(totals.lpv);
                document.getElementById('searches').textContent = formatNumber(totals.searches);
                document.getElementById('atc').textContent = formatNumber(totals.atc);
                document.getElementById('ic').textContent = formatNumber(totals.ic);
                document.getElementById('pia').textContent = formatNumber(totals.pia);
                document.getElementById('purchases').textContent = formatNumber(totals.purchases);

                // Calculate conversion rates
                const lpvToSearch = totals.lpv > 0 ? (totals.searches / totals.lpv * 100).toFixed(1) : 0;
                const searchToAtc = totals.searches > 0 ? (totals.atc / totals.searches * 100).toFixed(1) : 0;
                const atcToIc = totals.atc > 0 ? (totals.ic / totals.atc * 100).toFixed(1) : 0;
                const icToPia = totals.ic > 0 ? (totals.pia / totals.ic * 100).toFixed(1) : 0;
                const piaToPurchase = totals.pia > 0 ? (totals.purchases / totals.pia * 100).toFixed(1) : 0;

                document.getElementById('lpv-to-search-rate').textContent = `${lpvToSearch}%`;
                document.getElementById('search-to-atc-rate').textContent = `${searchToAtc}%`;
                document.getElementById('atc-to-ic-rate').textContent = `${atcToIc}%`;
                document.getElementById('ic-to-pia-rate').textContent = `${icToPia}%`;
                document.getElementById('pia-to-purchase-rate').textContent = `${piaToPurchase}%`;

                // Ad metrics
                document.getElementById('spend').textContent = formatCurrency(totals.spend);
                document.getElementById('roas').textContent = `${overallROAS.toFixed(2)}x`;
                
                const avgCpm = fbData.length > 0 ? fbData.reduce((sum, d) => sum + d.cpm, 0) / fbData.length : 0;
                const avgCpc = fbData.length > 0 ? fbData.reduce((sum, d) => sum + d.cpc, 0) / fbData.length : 0;
                document.getElementById('cpm').textContent = formatCurrency(avgCpm);
                document.getElementById('cpc').textContent = formatCurrency(avgCpc);

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        document.getElementById('refresh-btn').addEventListener('click', fetchData);
        window.addEventListener('load', fetchData);
    </script>
</body>
</html>